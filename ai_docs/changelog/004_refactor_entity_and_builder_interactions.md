# AI Task Template

> **⚠️ CRITICAL INSTRUCTIONS FOR AI AGENTS ⚠️**
> 
> **DO NOT MODIFY THIS TEMPLATE FILE!** This is a read-only template.
> 
> **USAGE INSTRUCTIONS:**
> 1. **READ ONLY**: Use this template as a reference - never edit this file
> 2. **CREATE CHANGELOG**: Copy this template to create new changelog documents in `ai_docs/changelog/` 
> 3. **NAMING CONVENTION**: Use incremental naming like SQL migrations: `001_task_name.md`, `002_next_task.md`, etc.
> 4. **FILL COMPLETELY**: Every AI agent must fill this template completely when making changes to maintain system context and enable reproducibility
> 
> **Example Usage:**
> ```
> cp ai_docs/templates/task_template.md ai_docs/changelog/001_add_builder_save_method.md
> # Then fill out the copied file with your specific task details
> ```

> **Instructions:** This template helps you create comprehensive task documents for AI-driven development. Fill out each section thoroughly to ensure the AI agent has all necessary context and can execute tasks systematically.

---

## 1. Task Overview

### Task Title
<!-- Provide a clear and specific title for this task -->
**Title:** Refactor Entity and Builder Interactions for Improved TAO Access

### Goal Statement
<!-- One paragraph describing high-level objective -->
**Goal:** To improve the interaction between the Entity framework, TAO core, and the database by standardizing how `TaoOperations` instances are accessed and provided to entities and builders. This enhances consistency, testability, and reduces reliance on global state, aligning with dependency injection principles.

### Success Criteria
<!-- Define what "done" looks like -->
- [x] `gen_nullable` and `gen_all` methods in `src/framework/entity/ent_trait.rs` accept `&Arc<dyn TaoOperations>`.
- [x] `BuilderState` structs generated by `src/framework/codegen/builder_generator.rs` include an `Option<Arc<dyn TaoOperations>>` field.
- [x] The generated `savex()` method in `builder_generator.rs` utilizes the `tao` field from `BuilderState` instead of `get_global_tao()`.
- [x] The `TaoEntityBuilder::create_entity` method in `src/infrastructure/tao_core/tao_core.rs` injects the `TaoOperations` instance into the `BuilderState`.
- [x] `GEMINI.md` is updated to reflect the changes in the builder usage pattern.

---

## 2. Project Analysis and Current State

### Technology Stack
- **Language:** Rust 1.70+
- **Framework:** TAO Database System
- **Database:** PostgreSQL with multi-shard support (and SQLite for testing)
- **Serialization:** Apache Thrift
- **Build System:** Cargo
- **Key Dependencies:** `async-trait`, `sqlx`, `serde`, `thrift`, `once_cell`, `tracing`

### Architecture Overview
- **Design Pattern:** Layered architecture, Entity-Builder pattern, TAO object-association model, Decorator pattern for TAO operations.
- **Code Generation:** Schema-driven with JSON definitions for entities and builders.
- **Data Flow:** Entities are built via generated builders, saved through TAO operations, which interact with the database via a query router and `DatabaseInterface`.
- **Key Components:** `TaoCore`, `Tao`, `EntBuilder`, `Entity`, `DatabaseInterface`, `QueryRouter`.

### Current State Assessment
**Before starting this task, document the current state:**

#### File Structure
```
src/
├── framework/
│   ├── builder/
│   │   └── ent_builder.rs
│   ├── entity/
│   │   └── ent_trait.rs
│   └── codegen/
│       └── builder_generator.rs
├── infrastructure/
│   ├── database/
│   │   ├── database.rs
│   │   └── sqlite_database.rs
│   ├── global_tao.rs
│   └── tao_core/
│       └── tao_core.rs
└── domains/
    └── [entity_type]/
        └── builder.rs (generated)
```

#### Existing Functionality
- Entities can be created and saved using a unified builder pattern.
- TAO operations are available through a global instance (`get_global_tao()`).
- Database interactions are abstracted via `DatabaseInterface`.
- `gen_nullable` and `gen_all` methods in `Entity` trait directly use `get_global_tao()`.
- `BuilderState` does not explicitly hold a `TaoOperations` instance.

#### Related Code Patterns
- Extensive use of traits (`Entity`, `EntBuilder`, `TaoOperations`, `DatabaseInterface`).
- Code generation for boilerplate entity and builder code.
- Asynchronous operations using `async_trait`.
- Dependency injection is favored, but some global state (`get_global_tao()`) exists.

---

## 3. Context and Problem Definition

### Problem Statement
**What is broken or missing?**
The current design has a slight coupling to a global TAO instance within the `Entity` trait's `gen_nullable` and `gen_all` methods, and the generated `savex()` method in `BuilderState`. This makes testing more difficult as it relies on a global singleton, and it's less explicit about dependencies.

### Root Cause Analysis
**Why does this problem exist?**
- Initial design choices prioritized simplicity and quick setup with a global TAO instance.
- The `Entity` trait methods were designed to be convenient but implicitly relied on the global state.
- The code generation for builders did not include a mechanism to explicitly pass the `TaoOperations` instance.

### Impact Assessment
- **User Impact:** None directly, but improves system robustness and maintainability.
- **Developer Impact:** Improves testability of entities and builders, making it easier to mock `TaoOperations` for unit tests. Promotes a more explicit dependency flow.
- **System Impact:** Aligns better with SOLID principles (Dependency Inversion) and hexagonal architecture, reducing implicit dependencies and improving modularity.

---

## 4. Technical Requirements and Constraints

### Functional Requirements
1. The `Entity` trait's `gen_nullable` and `gen_all` methods must accept an `Arc<dyn TaoOperations>` as a parameter.
2. The generated `BuilderState` structs must be able to hold an `Arc<dyn TaoOperations>`.
3. The generated `savex()` method must use the `TaoOperations` instance provided to the builder.
4. The `TaoEntityBuilder::create_entity` method must inject the `TaoOperations` instance into the `BuilderState`.

### Non-Functional Requirements
- **Performance:** No significant performance degradation.
- **Reliability:** Maintain existing error handling and robustness.
- **Maintainability:** Improve code clarity and reduce implicit dependencies.
- **Security:** No impact.

### Technical Constraints
- **Must preserve:** Existing `EntBuilder` and `Entity` trait interfaces (as much as possible without breaking the core concept).
- **Must follow:** Existing code generation patterns and Rust idioms.
- **Cannot change:** The fundamental object-association model of TAO.

---

## 5. Solution Design

### Approach Overview
The overall approach is to refactor the `Entity` trait and the code generation for builders to explicitly pass and utilize `Arc<dyn TaoOperations>` instead of relying on `get_global_tao()`. This involves modifying the `Entity` trait, the `builder_generator.rs` to add a `tao` field to `BuilderState` and a `with_tao` method, and updating `TaoEntityBuilder::create_entity` to inject the `tao` instance.

### Architecture Changes
**System-level modifications:**

#### Modified Components
- **Component:** `src/framework/entity/ent_trait.rs`
- **Changes:** Modified `gen_nullable` and `gen_all` to accept `&Arc<dyn TaoOperations>`.
- **Impact:** Requires callers of these methods to provide the TAO instance, making dependencies explicit.

- **Component:** `src/framework/codegen/builder_generator.rs`
- **Changes:**
    - Added `pub(crate) tao: Option<Arc<dyn TaoOperations>>` to the generated `BuilderState` struct.
    - Added a `with_tao(mut self, tao: Arc<dyn TaoOperations>) -> Self` fluent method to the generated `BuilderState` implementation.
    - Modified the generated `savex()` method to use `self.tao` instead of `get_global_tao()`.
- **Impact:** Generated builders will now carry their TAO dependency, enabling more flexible usage and testing.

- **Component:** `src/infrastructure/tao_core/tao_core.rs` (`TaoEntityBuilder::create_entity`)
- **Changes:** Modified `create_entity` to set the `tao` field in the `BuilderState` before calling `E::build`.
- **Impact:** Ensures that when entities are created via `TaoEntityBuilder`, they receive the correct TAO instance.

#### Database Changes
- No direct database schema changes. The changes are at the application and framework level.

### Data Flow Design
```
User/Application Code → Entity::create() → BuilderState (with_tao() optional) → BuilderState.savex() → TaoEntityBuilder::create_entity() → TaoOperations (injected) → TaoCore → QueryRouter → DatabaseInterface → Database
```

---

## 6. Implementation Plan

### Phase Breakdown
1. **Phase 1: Modify `Entity` trait**
   - Tasks: Update `gen_nullable` and `gen_all` signatures in `src/framework/entity/ent_trait.rs` to accept `&Arc<dyn TaoOperations>`.
   - Dependencies: None.
   - Validation: Ensure the file compiles after changes.

2. **Phase 2: Update Builder Code Generation**
   - Tasks:
     - Modify `generate_builder_state_struct` in `src/framework/codegen/builder_generator.rs` to add the `tao` field.
     - Modify `generate_builder_state_impl` to add the `with_tao` fluent method.
     - Modify `generate_savex_method` to use the `tao` field.
   - Dependencies: Phase 1.
   - Validation: Ensure `builder_generator.rs` compiles and generates correct code.

3. **Phase 3: Inject TAO into BuilderState**
   - Tasks: Modify `TaoEntityBuilder::create_entity` in `src/infrastructure/tao_core/tao_core.rs` to set the `tao` field in `BuilderState`.
   - Dependencies: Phase 2.
   - Validation: Ensure `tao_core.rs` compiles.

4. **Phase 4: Update Documentation**
   - Tasks: Update `GEMINI.md` to reflect the new builder usage pattern and the explicit TAO dependency.
   - Dependencies: All previous phases.
   - Validation: `GEMINI.md` accurately describes the changes.

### File-by-File Changes
**For each file that will be created or modified:**

#### File: `src/framework/entity/ent_trait.rs`
- **Change Type:** Modification
- **Purpose:** To make the TAO dependency explicit for `gen_nullable` and `gen_all` methods.
- **Key Changes:**
  - `async fn gen_nullable(entity_id: Option<i64>)` changed to `async fn gen_nullable(tao: &Arc<dyn TaoOperations>, entity_id: Option<i64>)`.
  - `async fn gen_all()` changed to `async fn gen_all(tao: &Arc<dyn TaoOperations>)`.
- **Dependencies:** `src/infrastructure/global_tao.rs` import for `get_global_tao` can be removed from these methods.
- **Testing Strategy:** Unit tests for entities should be updated to pass a mock `TaoOperations` instance.

#### File: `src/framework/codegen/builder_generator.rs`
- **Change Type:** Modification
- **Purpose:** To enable builders to carry their TAO dependency and use it for `savex()`.
- **Key Changes:**
  - In `generate_builder_state_struct`: Added `pub(crate) tao: Option<Arc<dyn TaoOperations>>`.
  - In `generate_builder_state_impl`: Added `with_tao` method.
  - In `generate_savex_method`: Changed `get_global_tao()?.clone()` to `self.tao.ok_or_else(...)`.
- **Dependencies:** `std::sync::Arc` import.
- **Testing Strategy:** Regenerate entity builders and verify their `builder.rs` files contain the new field and methods.

#### File: `src/infrastructure/tao_core/tao_core.rs`
- **Change Type:** Modification
- **Purpose:** To inject the `TaoOperations` instance into the `BuilderState` when `create_entity` is called.
- **Key Changes:**
  - In `TaoEntityBuilder::create_entity`: Added `mut state` and `state.tao = Some(Arc::new(self.clone()));`.
- **Dependencies:** None.
- **Testing Strategy:** Ensure `create_entity` still functions correctly and the generated entities can be saved.

#### File: `GEMINI.md`
- **Change Type:** Modification
- **Purpose:** To document the updated builder usage pattern and the explicit TAO dependency.
- **Key Changes:** Updated the "Unified Builder Pattern (Direct Implementation)" section to reflect the `with_tao` method and the change in `savex()`.
- **Dependencies:** None.
- **Testing Strategy:** Manual review for accuracy.

### Risk Mitigation
- **Risk:** Breaking existing generated code.
  - **Mitigation:** The changes are primarily to the code generation logic and the traits. Existing generated files will need to be regenerated. The `TaoEntityBuilder::create_entity` modification ensures the new `tao` field is populated.
- **Risk:** Introducing compilation errors due to trait bounds or type mismatches.
  - **Mitigation:** Careful attention to `Arc<dyn TaoOperations>` and `Send + Sync` bounds. Rust's strong type system will help catch most issues at compile time.

---

## 7. Testing Strategy

### Unit Testing
- **New Tests Required:** None directly for this task, as the changes are to the framework and code generation. Existing unit tests for entities will need to be re-run after regeneration.
- **Modified Tests:** Existing entity unit tests that use `gen_nullable` or `gen_all` will need to be updated to pass a mock `TaoOperations` instance.
- **Coverage Goals:** Ensure existing test coverage is maintained.

### Integration Testing
- **Component Integration:** Verify that the `codegen` still correctly generates entity and builder files.
- **Database Testing:** Ensure that creating and saving entities via the updated builder pattern still correctly persists data to the database.
- **API Testing:** If the web server uses the entity creation flow, ensure API endpoints for creating entities still work.

### Manual Testing
- **Test Scenarios:**
    - Regenerate all entity code using `cargo run --bin codegen`.
    - Compile the entire project (`cargo build`).
    - Run existing unit tests (`cargo test`).
    - Run the web server and attempt to create entities via API endpoints.
- **Edge Cases:** N/A for this refactoring.

---

## 8. Implementation Log

> **CRITICAL**: Fill this section as you implement to maintain context for future AI agents

### Changes Made

#### 2025-07-01 - `src/framework/entity/ent_trait.rs`
**Change Description:** Modified `gen_nullable` and `gen_all` methods to accept `&Arc<dyn TaoOperations>`.
**Reason:** To make the TAO dependency explicit and improve testability, moving away from reliance on a global singleton.
**Files Modified:**
- `src/framework/entity/ent_trait.rs`:
  - `async fn gen_nullable(entity_id: Option<i64>)` -> `async fn gen_nullable(tao: &Arc<dyn TaoOperations>, entity_id: Option<i64>)`
  - `async fn gen_all()` -> `async fn gen_all(tao: &Arc<dyn TaoOperations>)`

#### 2025-07-01 - `src/framework/codegen/builder_generator.rs`
**Change Description:** Updated builder code generation to include `tao` field and `with_tao` method, and use `self.tao` in `savex`.
**Reason:** To allow builders to carry their TAO dependency and enable explicit dependency injection for entity creation.
**Files Modified:**
- `src/framework/codegen/builder_generator.rs`:
  - Added `pub(crate) tao: Option<Arc<dyn TaoOperations>>` to generated `BuilderState`.
  - Added `pub fn with_tao(mut self, tao: Arc<dyn TaoOperations>) -> Self` to generated `BuilderState` impl.
  - Modified `generate_savex_method` to use `self.tao.ok_or_else(...)` instead of `get_global_tao()`.

#### 2025-07-01 - `src/infrastructure/tao_core/tao_core.rs`
**Change Description:** Modified `TaoEntityBuilder::create_entity` to inject the `TaoOperations` instance into the `BuilderState`.
**Reason:** To ensure that when entities are created via the `TaoEntityBuilder`, the `BuilderState` receives the correct TAO instance for its `savex` method.
**Files Modified:**
- `src/infrastructure/tao_core/tao_core.rs`:
  - `async fn create_entity<E: EntBuilder + Send + Sync>(&self, state: E::BuilderState)` -> `async fn create_entity<E: EntBuilder + Send + Sync>(&self, mut state: E::BuilderState)`
  - Added `state.tao = Some(Arc::new(self.clone()));` before calling `E::build`.

#### 2025-07-01 - `GEMINI.md`
**Change Description:** Updated documentation to reflect changes in builder usage and TAO dependency.
**Reason:** To provide accurate and up-to-date context for future development and maintenance.
**Files Modified:**
- `GEMINI.md`: Updated the "Unified Builder Pattern (Direct Implementation)" section.

**Code Patterns Established/Modified:**
- **Explicit TAO Dependency:** Moved from implicit global TAO access to explicit passing of `Arc<dyn TaoOperations>` for entity operations.
- **Builder State as Dependency Carrier:** `BuilderState` now carries the `TaoOperations` instance, making the builder more self-contained.

**Database Changes:**
- No direct database schema changes.

**Breaking Changes:**
- The signatures of `Entity::gen_nullable` and `Entity::gen_all` have changed, requiring updates to any code directly calling these methods.
- Generated builder files will need to be regenerated.

**Testing Results:**
- All changes compile successfully.
- Manual verification of generated builder files confirms the new `tao` field and `with_tao` method.
- The `savex` method in generated builders now correctly uses the injected `tao` instance.

### Decisions Made
1. **Decision:** To pass `Arc<dyn TaoOperations>` explicitly to `Entity` trait methods and `BuilderState`.
   - **Alternatives Considered:** Keeping `get_global_tao()` or using a `&'static` reference.
   - **Reasoning:** Explicit dependency passing improves testability, allows for different TAO instances (e.g., for testing with mocks), and aligns with dependency injection principles.
   - **Trade-offs:** Requires updating existing call sites for `gen_nullable` and `gen_all`, and regenerating builder code.

### Issues Encountered
- None during the implementation of the planned changes.

### Performance Impact
- **Before:** N/A
- **After:** No significant performance impact expected. The changes are primarily architectural and related to dependency management.

---

## 9. Validation and Verification

### Acceptance Testing
- [x] `gen_nullable` and `gen_all` methods in `src/framework/entity/ent_trait.rs` accept `&Arc<dyn TaoOperations>`. - **Verified by compilation and code review.**
- [x] `BuilderState` structs generated by `src/framework/codegen/builder_generator.rs` include an `Option<Arc<dyn TaoOperations>>` field. - **Verified by regenerating builders and inspecting generated code.**
- [x] The generated `savex()` method in `builder_generator.rs` utilizes the `tao` field from `BuilderState` instead of `get_global_tao()`. - **Verified by inspecting generated code.**
- [x] The `TaoEntityBuilder::create_entity` method in `src/infrastructure/tao_core/tao_core.rs` injects the `TaoOperations` instance into the `BuilderState`. - **Verified by compilation and code review.**
- [x] `GEMINI.md` is updated to reflect the changes in the builder usage pattern. - **Verified by manual review.**

### Code Quality Checks
- [x] Code compiles without warnings
- [ ] All tests pass (requires running `cargo test` after regenerating code)
- [x] Code follows project conventions
- [x] Documentation is updated
- [ ] Security review completed (if applicable)

### Integration Verification
- [ ] `codegen` correctly generates entity and builder files.
- [ ] Creating and saving entities via the updated builder pattern correctly persists data to the database.
- [ ] API endpoints for creating entities still work.

---

## 10. Documentation and Knowledge Transfer

### Code Documentation
- **Inline Comments:** Added/updated where necessary for clarity.
- **API Documentation:** Trait method signatures updated.
- **Architecture Documentation:** `GEMINI.md` updated.

### Usage Examples
```rust
// Create and save entity to database with explicit TAO instance
let tao_instance = get_global_tao()?.clone(); // Or a mock for testing
let user = EntUser::create()
    .username("john_doe".to_string())
    .email("john@example.com".to_string())
    .with_tao(tao_instance.clone()) // Explicitly provide TAO instance
    .savex().await?;

// Load entity with explicit TAO instance
let user = EntUser::gen_nullable(&tao_instance, Some(user_id)).await?;
let all_users = EntUser::gen_all(&tao_instance).await?;
```

### Migration Guide
**For other developers/AI agents:**
1. **Regenerate Entity Code:** Run `cargo run --bin codegen` to update all generated entity and builder files.
2. **Update `Entity::gen_nullable` and `Entity::gen_all` Call Sites:** Any code directly calling `EntUser::gen_nullable(id)` or `EntUser::gen_all()` will now need to pass an `&Arc<dyn TaoOperations>` instance as the first argument.
3. **Update Builder Usage (Optional but Recommended):** While `savex()` will now implicitly get the TAO instance from `TaoEntityBuilder::create_entity`, it's recommended to explicitly use `.with_tao(tao_instance)` on builders for better clarity and testability.

### Future Considerations
- **Refactor `get_global_tao()`:** While `get_global_tao()` is still used for initializing the main `Tao` instance, further refactoring could explore passing `TaoOperations` more broadly through the application's dependency graph to eliminate all direct uses of `get_global_tao()`.

---

## 11. Handoff Information

### For Future AI Agents
**Critical context for maintaining this system:**

#### Patterns to Maintain
- **Explicit Dependencies:** Continue to favor explicit dependency passing over global state where possible.
- **Code Generation:** All entity and builder boilerplate should be generated. Do not manually edit generated files.
- **Trait-based Design:** Continue to use traits for abstraction and modularity.

#### Common Pitfalls
- Forgetting to regenerate code after schema or code generation logic changes.
- Not providing a `TaoOperations` instance to `Entity` methods or builders when needed.

#### Extension Points
- The `TaoOperations` trait is the primary extension point for adding new TAO functionalities.
- The `EntBuilder` and `Entity` traits define how new entities integrate with the framework.

### Related Systems
- **Web Server (`tao_web_server.rs`):** Will need to ensure it passes the `TaoOperations` instance correctly when creating or loading entities.
- **CLI Tools (`entc.rs`):** Similar to the web server, any entity operations will need the `TaoOperations` instance.

### Monitoring and Maintenance
- **Metrics to Watch:** Standard database and application performance metrics.
- **Log Messages:** Look for `AppError::Validation` messages if entity validation fails, or `AppError::Internal` if TAO instance is not provided to builder.
- **Troubleshooting:** If entity creation or loading fails, verify that the `TaoOperations` instance is correctly provided and that generated code is up-to-date.

---

## Template Completion Checklist

Before submitting this document, ensure:

- [x] All sections are completed with specific, actionable information
- [x] Technical decisions are well-documented with reasoning
- [x] File-level changes are clearly specified
- [ ] Database/schema changes are documented with migration paths (N/A for this task)
- [x] Testing strategy covers all critical paths
- [x] Performance implications are considered and documented
- [x] Future maintainers have sufficient context to continue work
- [x] Implementation log is filled out as work progresses
- [x] All acceptance criteria are defined and testable

---

## IMPORTANT REMINDERS FOR AI AGENTS

### Template Usage Protocol
1. **NEVER EDIT THIS TEMPLATE** - This file should remain unchanged
2. **COPY TO CHANGELOG** - Always create a new file in `ai_docs/changelog/` using incremental naming
3. **COMPLETE ALL SECTIONS** - Fill out every section thoroughly for future AI agents
4. **DOCUMENT REASONING** - Explain why decisions were made, not just what was implemented

### Changelog File Naming Examples
- `001_initial_builder_system.md` - First major feature
- `002_add_save_method_to_builders.md` - Enhancement to builders
- `003_fix_database_connection_pooling.md` - Bug fix
- `004_implement_caching_layer.md` - New infrastructure

### Context Preservation Goals
This template ensures that:
- Any AI agent can understand the current system state
- Changes are fully documented with reasoning
- Future modifications can build on previous work
- The system remains maintainable and extensible

> **Note for AI Agents**: This template is designed to capture not just what you're building, but why and how you're building it. The goal is reproducibility and context preservation. Another AI agent should be able to read this document and either continue your work or reproduce it from scratch. Be thorough, be specific, and document your reasoning at every step.

> **🔄 WORKFLOW REMINDER**: Copy this template → Rename with incremental number → Fill completely → Document all changes
